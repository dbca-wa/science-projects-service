name: "Test Suite"

on:
  # Only run on pull requests - not on direct pushes to main
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/**"
      - ".github/workflows/test.yml"
  
  # Run on pushes to develop branch for continuous testing
  push:
    branches: [develop]
    paths:
      - "backend/**"
      - ".github/workflows/test.yml"

permissions:
  contents: write  # Required for pushing to badges branch

jobs:
  test:
    name: Test (shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            .venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-
      
      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi
      
      - name: Restore test durations cache
        uses: actions/cache/restore@v4
        with:
          path: .test_durations
          key: test-durations-${{ github.sha }}
          restore-keys: |
            test-durations-
      
      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
          DJANGO_SETTINGS_MODULE: config.settings
          SECRET_KEY: test-secret-key-for-ci-${{ github.run_id }}
          DEBUG: "False"
          ENVIRONMENT: development
          EXTERNAL_PASS: "test-external-pass"
          LIBRARY_API_URL: "https://library-test.example.com/api"
          LIBRARY_BEARER_TOKEN: "test-bearer-token"
          IT_ASSETS_ACCESS_TOKEN: "test-it-assets-token"
          IT_ASSETS_USER: "test-user"
          PRINCE_SERVER_URL: ""
          DEFAULT_FROM_EMAIL: "test-noreply@example.com"
          SPMS_MAINTAINER_EMAIL: "test-maintainer@example.com"
          EMAIL_HOST: "localhost"
          EMAIL_PORT: "25"
          COVERAGE_FILE: .coverage.${{ matrix.shard }}
        run: |
          poetry run pytest \
            --splits 4 \
            --group ${{ matrix.shard }} \
            --store-durations \
            -n auto \
            --tb=short \
            --cov=. \
            --cov-report= \
            -v \
            -ra \
            --maxfail=5
      
      - name: Debug coverage files
        if: always()
        run: |
          echo "=== Coverage files in current directory ==="
          ls -la .coverage* 2>/dev/null || echo "No .coverage files found"
          echo ""
          echo "=== All coverage-related files ==="
          find . -name '.coverage*' -type f 2>/dev/null || echo "No coverage files found anywhere"
      
      - name: Save test durations cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .test_durations
          key: test-durations-${{ github.sha }}
      
      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-${{ matrix.shard }}
          path: .coverage.${{ matrix.shard }}
          retention-days: 1
  
  # Combine coverage from all shards
  coverage:
    name: Combine coverage and upload
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi --only main,dev
      
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports
      
      - name: Debug coverage files
        run: |
          echo "=== Downloaded artifacts structure ==="
          ls -laR coverage-reports/
          echo ""
          echo "=== Coverage files found ==="
          find coverage-reports -name '.coverage*' -type f
          echo ""
          echo "=== File count ==="
          find coverage-reports -name '.coverage*' -type f | wc -l
      
      - name: Combine coverage data
        run: |
          # Find and list all coverage files for debugging
          echo "=== Coverage files found ==="
          find coverage-reports -name '.coverage*' -type f
          
          # Combine binary coverage files (handles .coverage.N and .coverage.N.*)
          poetry run coverage combine coverage-reports/*/.coverage*
          
          # Generate reports from combined data
          poetry run coverage xml -o coverage.xml
          poetry run coverage html
          poetry run coverage report --fail-under=80
      
      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-combined-${{ github.run_id }}
          path: htmlcov/
          retention-days: 30
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        with:
          file: coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
      
      - name: Generate Coverage Badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.test.result == 'success'
        uses: tj-actions/coverage-badge-py@v2
        with:
          output: coverage.svg
        continue-on-error: true
        id: badge-generation
      
      - name: Checkout badges branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.badge-generation.outcome == 'success'
        uses: actions/checkout@v4
        with:
          ref: badges
          path: badges-repo
        continue-on-error: true
      
      - name: Store badge in badges branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.badge-generation.outcome == 'success'
        run: |
          cd badges-repo
          
          # Copy badge file
          cp ../coverage.svg coverage.svg
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push if changed
          git add coverage.svg
          if git diff --staged --quiet; then
            echo "âœ… No changes to coverage badge"
          else
            git commit -m "Update coverage badge [skip ci]"
            git push origin badges
            echo "âœ… Coverage badge updated"
          fi
        continue-on-error: true
      
      - name: Check badge generation outcome
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ "${{ steps.badge-generation.outcome }}" == "failure" ]; then
            echo "::warning::Badge generation failed - coverage.xml may be invalid"
          elif [ "${{ steps.badge-generation.outcome }}" == "success" ]; then
            echo "âœ… Coverage badge generated successfully"
          else
            echo "::warning::Badge generation was skipped"
          fi
      
      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests completed across 4 shards" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Coverage report uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Minimum coverage: 80%" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ Sharding reduces wall time by ~75%" >> $GITHUB_STEP_SUMMARY
