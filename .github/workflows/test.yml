name: "Test Suite"

on:
  # Run on pull requests
  pull_request:
    branches: [main, develop]

  # Run on pushes to main and develop branches
  # main: for Codecov upload after merge
  # develop: for continuous testing
  push:
    branches: [main, develop]

permissions:
  contents: write  # Required for pushing to badges branch

jobs:
  test:
    name: Test (shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            .venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi

      - name: Restore test durations cache
        uses: actions/cache/restore@v4
        with:
          path: .test_durations
          key: test-durations-${{ github.sha }}-${{ matrix.shard }}
          restore-keys: |
            test-durations-combined-
            test-durations-
        continue-on-error: true

      - name: Validate test durations file
        if: always()
        run: |
          if [ -f ".test_durations" ]; then
            echo "=== Checking test durations file ==="
            if python3 -c "import json; json.load(open('.test_durations'))" 2>/dev/null; then
              echo "âœ… Test durations file is valid JSON"
            else
              echo "âš ï¸ Test durations file is corrupted, removing it"
              rm -f .test_durations
            fi
          else
            echo "â„¹ï¸ No test durations file found (first run or cache miss)"
          fi

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
          DJANGO_SETTINGS_MODULE: config.settings
          SECRET_KEY: test-secret-key-for-ci-${{ github.run_id }}
          DEBUG: "False"
          ENVIRONMENT: development
          EXTERNAL_PASS: "test-external-pass"
          LIBRARY_API_URL: "https://library-test.example.com/api"
          LIBRARY_BEARER_TOKEN: "test-bearer-token"
          IT_ASSETS_ACCESS_TOKEN: "test-it-assets-token"
          IT_ASSETS_USER: "test-user"
          PRINCE_SERVER_URL: ""
          DEFAULT_FROM_EMAIL: "test-noreply@example.com"
          SPMS_MAINTAINER_EMAIL: "test-maintainer@example.com"
          EMAIL_HOST: "localhost"
          EMAIL_PORT: "25"
        run: |
          poetry run pytest \
            --splits 4 \
            --group ${{ matrix.shard }} \
            --store-durations \
            -n auto \
            --tb=short \
            --cov=. \
            --cov-report= \
            -v \
            -ra \
            --maxfail=5

      - name: Debug coverage files
        if: always()
        run: |
          echo "=== Coverage files in current directory ==="
          ls -la .coverage* 2>/dev/null || echo "No .coverage files found"
          echo ""
          echo "=== All coverage-related files ==="
          find . -name '.coverage*' -type f 2>/dev/null || echo "No coverage files found anywhere"
          echo ""
          echo "=== Current working directory ==="
          pwd

      - name: Prepare coverage file for upload
        if: always()
        run: |
          mkdir -p coverage-output

          # Handle .coverage file
          if [ -f ".coverage" ]; then
            echo "âœ… Found .coverage file"
            cp .coverage "coverage-output/.coverage.${{ matrix.shard }}"
            echo "Copied .coverage as .coverage.${{ matrix.shard }}"
          fi

          # Handle .coverage.* files (use nullglob to handle no matches)
          shopt -s nullglob
          coverage_dotfiles=(.coverage.*)
          shopt -u nullglob

          for file in "${coverage_dotfiles[@]}"; do
            if [ "$file" != ".coveragerc" ] && [ -f "$file" ]; then
              cp "$file" coverage-output/
              echo "Copied $file"
            fi
          done

          echo ""
          echo "=== Files in coverage-output/ ==="
          ls -la coverage-output/

          # Verify at least one file was copied
          if [ -z "$(ls -A coverage-output/)" ]; then
            echo "âŒ ERROR: No coverage files were copied"
            exit 1
          fi

          echo "âœ… Successfully prepared coverage files for upload"

      - name: Save test durations cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .test_durations
          key: test-durations-${{ github.sha }}-${{ matrix.shard }}

      - name: Debug paths before upload
        if: always()
        run: |
          echo "=== Workspace info ==="
          echo "GITHUB_WORKSPACE: ${{ github.workspace }}"
          echo "PWD: $(pwd)"
          echo ""
          echo "=== Coverage output from PWD ==="
          ls -la coverage-output/ || echo "Not found at PWD"
          echo ""
          echo "=== Coverage output from workspace ==="
          ls -la "${{ github.workspace }}/coverage-output/" || echo "Not found at workspace"
          echo ""
          echo "=== Finding all coverage-output directories ==="
          find "${{ github.workspace }}" -type d -name "coverage-output" -exec ls -la {} \;

      - name: Upload test durations
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-durations-${{ matrix.shard }}
          path: .test_durations
          retention-days: 7
          if-no-files-found: warn
          include-hidden-files: true

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-${{ matrix.shard }}
          path: coverage-output/.coverage.*
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

  # Combine coverage from all shards
  coverage:
    name: Combine coverage and upload
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi --only main,dev

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports

      - name: Download all test durations
        uses: actions/download-artifact@v4
        with:
          pattern: test-durations-*
          path: test-durations-reports
        continue-on-error: true

      - name: Combine test durations
        if: always()
        run: |
          if [ -d "test-durations-reports" ]; then
            echo "=== Combining test durations from all shards ==="

            # Merge JSON files properly using Python
            python3 << 'EOF'
          import json
          import os
          from pathlib import Path

          combined = {}
          reports_dir = Path("test-durations-reports")

          # Find all .test_durations files
          for duration_file in reports_dir.rglob(".test_durations"):
              try:
                  with open(duration_file, 'r') as f:
                      data = json.load(f)
                      combined.update(data)
                      print(f"âœ… Merged {duration_file}")
              except json.JSONDecodeError as e:
                  print(f"âš ï¸ Skipping corrupted file {duration_file}: {e}")
              except Exception as e:
                  print(f"âš ï¸ Error reading {duration_file}: {e}")

          # Write combined durations
          if combined:
              with open(".test_durations", 'w') as f:
                  json.dump(combined, f)
              print(f"âœ… Combined {len(combined)} test durations")
          else:
              print("âš ï¸ No test durations found to combine")
          EOF

            if [ -f ".test_durations" ]; then
              echo "âœ… Combined test durations file created"
              wc -l .test_durations
            fi
          fi
        continue-on-error: true

      - name: Save combined test durations cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .test_durations
          key: test-durations-combined-${{ github.sha }}
        continue-on-error: true

      - name: Debug coverage files
        run: |
          echo "=== Downloaded artifacts structure ==="
          ls -laR coverage-reports/
          echo ""
          echo "=== Coverage files found ==="
          find coverage-reports -name '.coverage.*' -type f
          echo ""
          echo "=== File count ==="
          find coverage-reports -name '.coverage.*' -type f | wc -l

      - name: Combine coverage data
        run: |
          # Move all coverage files to current directory for combining
          echo "=== Moving coverage files to current directory ==="
          find coverage-reports -name '.coverage.*' -type f -exec mv {} . \;

          # List files in current directory
          echo "=== Coverage files in current directory ==="
          ls -la .coverage.* 2>/dev/null || echo "No coverage files found"

          # Count coverage files
          coverage_count=$(find . -maxdepth 1 -name '.coverage.*' -type f | wc -l)
          echo "Found $coverage_count coverage file(s)"

          if [ "$coverage_count" -eq 0 ]; then
            echo "âŒ ERROR: No coverage files found to combine"
            exit 1
          fi

          # Combine binary coverage files
          echo "=== Combining coverage data ==="
          poetry run coverage combine

          # Generate reports from combined data
          echo "=== Generating coverage reports ==="
          poetry run coverage xml -o coverage.xml
          poetry run coverage html

          # Get coverage percentage and save to file
          COVERAGE=$(poetry run coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          echo "${COVERAGE}" > coverage-percentage.txt

          # Verify minimum coverage
          poetry run coverage report --fail-under=80

      - name: Update README with coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Read coverage percentage
          COVERAGE=$(cat coverage-percentage.txt)

          # Determine badge colour
          if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="green"
          elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
            COLOR="yellow"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            COLOR="orange"
          else
            COLOR="red"
          fi

          # Create new badge markdown
          NEW_BADGE="![Coverage](https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR})"

          # Update README.md (replace the coverage badge line)
          sed -i "s|!\[Coverage\](https://img.shields.io/badge/coverage-[0-9]*%25-[a-z]*)|${NEW_BADGE}|g" README.md

          echo "Updated coverage badge to: ${NEW_BADGE}"

          # Check if there are changes
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            echo "README.md updated with new coverage badge"
          fi

      - name: Commit and push README changes
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if git diff --quiet README.md; then
            echo "âœ… No changes to commit"
          else
            # Commit and push
            git add README.md
            git commit -m "chore: update coverage badge to $(cat coverage-percentage.txt)% [skip ci]"
            git push origin main
            echo "âœ… Coverage badge updated in README"
          fi

      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-combined-${{ github.run_id }}
          path: htmlcov/
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests completed across 4 shards" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Coverage report uploaded as artifact" >> $GITHUB_STEP_SUMMARY

          if [ -f "coverage-percentage.txt" ]; then
            COVERAGE=$(cat coverage-percentage.txt)
            echo "ðŸ“ˆ Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸŽ¯ Minimum coverage: 80%" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ Sharding reduces wall time by ~75%" >> $GITHUB_STEP_SUMMARY
