name: "Run Backend Tests"

on:
    push:
        branches: [main, develop]
        paths:
            - "backend/**"
            - ".github/workflows/run-tests.yml"
    pull_request:
        branches: [main, develop]
        paths:
            - "backend/**"
            - ".github/workflows/run-tests.yml"

jobs:
    test:
        name: Run tests with coverage
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_DB: test_db
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_pass
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            #----------------------------------------------
            # Checkout repo
            #----------------------------------------------
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            #----------------------------------------------
            # Set up Python
            #----------------------------------------------
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            #----------------------------------------------
            # Install Poetry
            #----------------------------------------------
            - name: Install Poetry
              run: |
                  curl -sSL https://install.python-poetry.org | python3 -
                  echo "$HOME/.local/bin" >> $GITHUB_PATH

            #----------------------------------------------
            # Cache Poetry dependencies
            #----------------------------------------------
            - name: Cache Poetry dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/pypoetry
                      .venv
                  key: ${{ runner.os }}-poetry-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-poetry-

            #----------------------------------------------
            # Install dependencies
            #----------------------------------------------
            - name: Install dependencies
              run: |
                  poetry config virtualenvs.in-project true
                  poetry install --no-interaction --no-ansi

            #----------------------------------------------
            # Run tests with coverage
            #----------------------------------------------
            - name: Run tests with coverage
              env:
                  DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
                  DJANGO_SETTINGS_MODULE: config.settings
                  SECRET_KEY: test-secret-key-for-ci
                  DEBUG: "False"
              run: |
                  poetry run pytest \
                    -n auto \
                    --cov=. \
                    --cov-report=xml \
                    --cov-report=html \
                    --cov-report=term-missing:skip-covered \
                    --cov-fail-under=60 \
                    --tb=short \
                    -v \
                    -ra

            #----------------------------------------------
            # Upload coverage report as artifact
            #----------------------------------------------
            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-report
                  path: htmlcov/
                  retention-days: 30

            #----------------------------------------------
            # Upload coverage to Codecov (optional)
            #----------------------------------------------
            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              if: github.event_name == 'push' || github.event_name == 'pull_request'
              with:
                  file: ./coverage.xml
                  flags: backend
                  name: backend-coverage
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
              continue-on-error: true

            #----------------------------------------------
            # Test Summary
            #----------------------------------------------
            - name: Test Summary
              if: always()
              run: |
                  echo "## Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Tests completed with parallel execution" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“Š Coverage report uploaded as artifact" >> $GITHUB_STEP_SUMMARY
